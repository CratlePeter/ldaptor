#!/usr/bin/python

from __future__ import print_function
import sys
from twisted.internet import protocol, defer, reactor
from ldaptor.protocols.ldap import distinguishedname, ldapconnector, ldapsyntax, ldapclient
from ldaptor.protocols import pureber, pureldap
from ldaptor import usage, ldapfilter, config, dns

def printIPAddressVOne(name, ip):
    print('A'+name+'.%|86400|'+ip)

def printPTRVOne(name, ip):
    octets = ip.split('.')
    octets.reverse()
    octets.append('in-addr.arpa.')
    print('P'+('.'.join(octets))+'|86400|'+name+'.%')

class HostIPAddress:
    def __init__(self, host, ipAddress):
        self.host = host
        self.ipAddress = ipAddress

    def createConfEntry(self):
        print('#Host:'+self.host.dn)
        if 1 == 1:
            printIPAddressVOne(self.host.name, self.ipAddress)
            printPTRVOne(self.host.name, self.ipAddress)
        elif 1 == 2:
            printIPAddressVOne(self.host.name, self.ipAddress)
            printPTRVOne(self.host.name, self.ipAddress)

    def __repr__(self):
        return (self.__class__.__name__
                +'('
                +'host=%r, ' % self.host.name
                +'ipAddress=%s' % repr(self.ipAddress)
                +')')

class Host:
    def __init__(self, dn, name, ipAddresses):
        self.dn = dn
        self.name = name
        self.ipAddresses = [HostIPAddress(self, ip) for ip in ipAddresses]

    def __repr__(self):
        return (self.__class__.__name__
                +'('
                +'dn=%s, ' % repr(self.dn)
                +'name=%s, ' % repr(self.name)
                +'ipAddresses=%s' % repr(self.ipAddresses)
                +')')

exitStatus = 0

def error(fail):
    print('fail:', str(fail), file=sys.stderr) #.getErrorMessage()
    global exitStatus
    exitStatus = 1

def only(serverResponse, attrName):
    assert len(serverResponse[attrName]) == 1, \
           "object %s attribute %r has multiple values: %s" \
           % (serverResponse.dn, attrName, serverResponse[attrName])
    for val in serverResponse[attrName]:
        return val

def getHosts(serverResponse, filterText):
    filt = pureldap.LDAPFilter_equalityMatch(
        attributeDesc=pureldap.LDAPAttributeDescription('objectClass'),
        assertionValue=pureber.BEROctetString('maradnsRecord'))
    if filterText:
        filt = pureldap.LDAPFilter_and(value=(filterText, filt))
    def _cbGotHost(serverResponse):
        host = Host(str(serverResponse.dn),
                    str(only(serverResponse, 'idnsName')),
                    list(str(i) for i in serverResponse['FQDNRecord']))
        for hostIP in host.ipAddresses:
            hostIP.createConfEntry()

    d = serverResponse.search(filterObject=filt,
                              attributes=[
                                  'idnsName', 'FQDNRecord',
                                  'ARecord', 'cNAMERecord',
                                  'dNSTTL', 'mXRecord',
                                  'NSRecord'],
                              callback=_cbGotHost)
    return d

def cbConnected(client, cfg, filterText):
    serverResponse = ldapsyntax.LDAPEntryWithClient(client, cfg.getBaseDN())
    d = getHosts(serverResponse, filterText)
    def unbind(r, serverResponse):
        serverResponse.client.unbind()
        return r
    d.addCallback(unbind, serverResponse)
    return d

def main(cfg, filter_text):
    from twisted.python import log
    log.startLogging(sys.stderr, setStdout=0)

    try:
        baseDN = cfg.getBaseDN()
    except config.MissingBaseDNError as e:
        print("%s: %s." % (sys.argv[0], e), file=sys.stderr)
        sys.exit(1)

    if filter_text is not None:
        filt = ldapfilter.parseFilter(filter_text)
    else:
        filt = None

    c = ldapconnector.LDAPClientCreator(reactor, ldapclient.LDAPClient)
    d = c.connectAnonymously(
        baseDN,
        overrides=cfg.getServiceLocationOverrides())
    d.addCallback(cbConnected, cfg, filt)
    d.addErrback(error)
    d.addBoth(lambda x: reactor.stop())

    reactor.run()
    sys.exit(exitStatus)

class MyOptions(usage.Options, usage.Options_service_location, usage.Options_base_optional):
    """LDAPtor maradns v1 and v2 zone file exporter"""
    def parseArgs(self, customFilter=None):
        self.opts['customFilter'] = customFilter

if __name__ == "__main__":
    import sys
    try:
        opts = MyOptions()
        opts.parseOptions()
    except usage.UsageError as ue:
        sys.stderr.write('%s: %s\n' % (sys.argv[0], ue))
        sys.exit(1)

    cfg = config.LDAPConfig(baseDN=opts['base'],
                            serviceLocationOverrides=opts['service-location'])
    main(cfg,
         opts['customFilter'])
