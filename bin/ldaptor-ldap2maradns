#!/usr/bin/python

from __future__ import print_function
import sys
from twisted.internet import protocol, defer, reactor
from ldaptor.protocols.ldap import distinguishedname, ldapconnector, ldapsyntax, ldapclient
from ldaptor.protocols import pureber, pureldap
from ldaptor import usage, ldapfilter, config, dns

def _printIPAddressVOne(name, ip):
    print('A'+name+'.%|86400|'+ip)

def _printPTRVOne(name, ip):
    octets = ip.split('.')
    octets.reverse()
    octets.append('in-addr.arpa.')
    print('P'+('.'.join(octets))+'|86400|'+name+'.%')

def _printHostLineVTwo(name, ttl, recordType,ip):
    nameStr=name+'.'
    if '.' not in name: nameStr=name+'.%'
    print(nameStr+'\t'+'+'+ttl+'\t'+recordType+'\t'+ip+' ~')

def _printPTRVTwo(name, ttl, ip):
    octets = ip.split('.')
    octets.reverse()
    octets.append('in-addr.arpa.')
    nameStr=name+'.'
    if '.' not in name: nameStr=name+'.%'
    print (('.'.join(octets))+'\t','+'+ttl+'\tPTR\t'+nameStr+' ~')

exitStatus = 0

def error(fail):
    print('fail:', str(fail), file=sys.stderr) #.getErrorMessage()
    global exitStatus
    exitStatus = 1

def only(serverResponse, attrName):
    assert len(serverResponse[attrName]) == 1, \
           "object %s attribute %r has multiple values: %s" \
           % (serverResponse.dn, attrName, serverResponse[attrName])
    for val in serverResponse[attrName]:
        return val

def getHosts(serverRequest, maraDnsVersion, filterText):
    filt = pureldap.LDAPFilter_equalityMatch(
        attributeDesc=pureldap.LDAPAttributeDescription('objectClass'),
        assertionValue=pureber.BEROctetString('maradnsRecord'))
    if filterText:
        filt = pureldap.LDAPFilter_and(value=(filterText, filt))

    def _cbGotHost(serverResponse):
        name = str(only(serverResponse, 'idnsName'))

        ttl = '86400'
        if 'dNSTTL' in serverResponse.keys(): ttl = str(only(serverResponse, 'dNSTTL'))
        
        if 'FQDNRecord' in serverResponse.keys():
            for ipAddress in serverResponse['FQDNRecord']:
                _printHostLineVTwo (name, ttl, 'FQDN4', ipAddress) 


    serverResponse = serverRequest.search(filterObject=filt,
                              attributes=[
                                  'idnsName', 'FQDNRecord',
                                  'ARecord', 'cNAMERecord',
                                  'dNSTTL', 'mXRecord',
                                  'NSRecord'],
                              callback=_cbGotHost)
    return serverResponse 

def cbConnected(client, cfg, maraDnsVersion, filterText):
    serverRequest = ldapsyntax.LDAPEntryWithClient(client, cfg.getBaseDN())
    d = getHosts(serverRequest, maraDnsVersion, filterText)
    def unbind(r, serverRequest):
        serverRequest.client.unbind()
        return r
    d.addCallback(unbind, serverRequest)
    return d

def main(cfg, maraDnsVersion, filterText):
    from twisted.python import log
    log.startLogging(sys.stderr, setStdout=0)

    try:
        baseDN = cfg.getBaseDN()
    except config.MissingBaseDNError as e:
        print("%s: %s." % (sys.argv[0], e), file=sys.stderr)
        sys.exit(1)

    if filterText is not None:
        filt = ldapfilter.parseFilter(filterText)
    else:
        filt = None

    c = ldapconnector.LDAPClientCreator(reactor, ldapclient.LDAPClient)
    d = c.connectAnonymously(
        baseDN,
        overrides=cfg.getServiceLocationOverrides())
    d.addCallback(cbConnected, cfg, maraDnsVersion, filt)
    d.addErrback(error)
    d.addBoth(lambda x: reactor.stop())

    reactor.run()
    sys.exit(exitStatus)

class MyOptions(usage.Options, usage.Options_service_location, usage.Options_base_optional):
    """LDAPtor maradns v1 and v2 zone file exporter"""
    def parseArgs(self, customFilter=None):
        self.opts['customFilter'] = customFilter

if __name__ == "__main__":
    try:
        opts = MyOptions()
        opts.parseOptions()
    except usage.UsageError as usageError:
        sys.stderr.write('%s: %s\n' % (sys.argv[0], usageError))
        sys.exit(1)

    cfg = config.LDAPConfig(baseDN=opts['base'],
                            serviceLocationOverrides=opts['service-location'])
    maraDnsVersion = config.maraDnsVersion()
    main(cfg,
         maraDnsVersion,
         opts['customFilter'])
